{% extends 'base.html' %}
{% block content %}
<h1>Long-term Analytics</h1>
<p class="muted">All-time trends across your entire dataset. Explore seasonality, category mix, and peak hours.</p>

<div class="grid">
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Monthly Revenue & Orders (All time)</h3>
      <a class="btn ghost" href="{% url 'managers:dashboard' %}">Back to Overview</a>
    </div>
    <canvas id="chart_monthly" height="140"></canvas>
  </div>

  <div class="card">
    <h3>Category Mix by Month (All time)</h3>
    <canvas id="chart_category" height="160"></canvas>
  </div>

  <div class="card">
    <h3>Peak Hours Heatmap (All time)</h3>
    <p class="muted">Orders by weekday and hour of day. Darker = busier.</p>
    <div id="heatmap" style="overflow:auto"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const fmtMoney = v => '$' + (Number(v||0)).toFixed(2);
  async function getJSON(url){
    const res = await fetch(url, {headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error('HTTP '+res.status);
    return await res.json();
  }

  function palette(n){
    // Generate n visually distinct colors
    const base = ['#ff4d4f','#ffc53d','#40c463','#7180b9','#ff8f1f','#9b59b6','#2ecc71','#e74c3c','#3498db','#27ae60','#e67e22'];
    const out=[]; for(let i=0;i<n;i++){ out.push(base[i%base.length]); } return out;
  }

  async function loadMonthly(){
    const data = await getJSON('{% url "managers:api_monthly" %}');
    const labels = data.points.map(p=>p.month);
    const revenue = data.points.map(p=>p.revenue);
    const orders = data.points.map(p=>p.orders);
    new Chart(document.getElementById('chart_monthly'), {
      type:'line',
      data:{
        labels,
        datasets:[
          {label:'Revenue', data:revenue, borderColor:'#ff4d4f', backgroundColor:'rgba(255,77,79,.18)', yAxisID:'y', tension:.25, fill:true},
          {label:'Orders', data:orders, borderColor:'#40c463', backgroundColor:'rgba(64,196,99,.18)', yAxisID:'y1', tension:.25}
        ]
      },
      options:{
        responsive:true,
        scales:{
          y:{type:'linear', position:'left', grid:{color:'rgba(255,255,255,.06)'}},
          y1:{type:'linear', position:'right', grid:{drawOnChartArea:false}},
          x:{grid:{color:'rgba(255,255,255,.06)'}}
        },
        plugins:{legend:{labels:{color:'#e8eaed'}}}
      }
    });
  }

  async function loadCategory(){
    const data = await getJSON('{% url "managers:api_category_monthly" %}');
    const months = Array.from(new Set(data.rows.map(r=>r.month))).sort();
    const categories = Array.from(new Set(data.rows.map(r=>r.category)));
    const colors = palette(categories.length);
    const map = {};
    for(const r of data.rows){
      const key = r.category + '|' + r.month;
      map[key] = r.revenue;
    }
    const datasets = categories.map((cat, i)=>({
      label: cat,
      data: months.map(m=>map[cat+'|'+m]||0),
      backgroundColor: colors[i]+'55',
      borderColor: colors[i],
      borderWidth: 1,
      stack: 'stack1'
    }));
    new Chart(document.getElementById('chart_category'), {
      type:'bar',
      data:{labels: months, datasets},
      options:{
        responsive:true,
        scales:{
          x:{stacked:true, grid:{color:'rgba(255,255,255,.06)'}},
          y:{stacked:true, grid:{color:'rgba(255,255,255,.06)'}}
        },
        plugins:{legend:{labels:{color:'#e8eaed'}}}
      }
    });
  }

  function renderHeatmap(containerId, rows, weekdayLabels){
    // Build a 7x24 grid of counts
    const max = rows.reduce((m,r)=> Math.max(m, r.orders), 0) || 1;
    const w = 26, h = 22; // cell size
    // Map rows for quick lookup; Django weekday 1..7 with Sunday=1
    const map = new Map();
    for(const r of rows){ map.set(`${r.weekday}-${r.hour}`, r.orders); }
    const labels = weekdayLabels; // ['Sun','Mon',...]
    let html = '<table style="border-collapse:collapse">';
    // header row
    html += '<tr><th></th>';
    for(let hr=0; hr<24; hr++){ html += `<th style="padding:4px;color:#a7adba">${hr}</th>`; }
    html += '</tr>';
    // rows
    for(let i=0;i<7;i++){
      const wd = i+1; // 1..7
      html += `<tr><th style="text-align:right;padding-right:6px;color:#a7adba">${labels[i]}</th>`;
      for(let hr=0; hr<24; hr++){
        const v = map.get(`${wd}-${hr}`) || 0;
        const intensity = Math.round((v / max) * 100);
        const bg = `linear-gradient(180deg, rgba(255,77,79,${0.08 + 0.6*(intensity/100)}), rgba(255,77,79,${0.08 + 0.6*(intensity/100)}))`;
        html += `<td title="${labels[i]} ${hr}:00 â€” ${v} orders" style="width:${w}px;height:${h}px;border:1px solid rgba(255,255,255,.06);background:${bg}"></td>`;
      }
      html += '</tr>';
    }
    html += '</table>';
    document.getElementById(containerId).innerHTML = html;
  }

  async function loadHeatmap(){
    const data = await getJSON('{% url "managers:api_hourly_heatmap" %}');
    renderHeatmap('heatmap', data.rows, data.weekday_labels);
  }

  async function init(){
    try{
      await loadMonthly();
      await loadCategory();
      await loadHeatmap();
    }catch(e){ console.error(e); }
  }
  init();
</script>
{% endblock %}
