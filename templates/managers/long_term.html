{% extends 'base.html' %}
{% block content %}
<h1>Long‑term Analytics</h1>
<p class="muted">Dive into your all‑time performance: seasonality, category mix, and peak hours. This page is fully rebuilt for clarity and compact layout.</p>

<style>
  /* Long-term page specific styles */
  .lt-wrap{display:grid;gap:16px;grid-template-columns:1fr}
  @media(min-width: 1100px){
    .lt-wrap{grid-template-columns:1fr 1fr}
    .lt-span-2{grid-column:1 / -1}
  }
  .lt-toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .lt-note{color:var(--muted);font-size:.86rem}
  .lt-canvas{width:100%;height:300px}
  .lt-canvas.sm{height:240px}
  .lt-canvas.md{height:300px}
  .lt-hm{max-height:320px;overflow:auto;border-radius:10px;border:1px solid rgba(255,255,255,.06)}
  .lt-hm table{width:max-content}
  .sticky-top th{position:sticky;top:0;background:rgba(255,255,255,.04);z-index:2}
  .sticky-left th:first-child{position:sticky;left:0;background:rgba(255,255,255,.04);z-index:3}
  .legend{display:flex;gap:10px;align-items:center;font-size:.82rem}
  .legend .sw{width:14px;height:14px;border-radius:4px;display:inline-block}
  .muted-small{color:var(--muted);font-size:.8rem}
  .error{color:#ff9aa0}
</style>

<div class="lt-wrap">
  <!-- Monthly overview -->
  <div class="card lt-span-2">
    <div class="lt-toolbar">
      <h3 style="margin:0">Monthly Revenue & Orders (All‑time)</h3>
      <div class="row">
        <button class="btn secondary" id="btn_refresh">Reload Data</button>
        <a class="btn ghost" href="{% url 'managers:dashboard' %}">Back to Overview</a>
      </div>
    </div>
    <p class="lt-note">Revenue shown as tomato line, orders as basil line. Hover to inspect values.</p>
    <div id="monthly_wrap">
      <div id="monthly_loading" class="muted-small">Loading monthly data…</div>
      <canvas id="chart_monthly" class="lt-canvas md" style="display:none"></canvas>
      <div id="monthly_error" class="muted-small error" style="display:none">Failed to load monthly data.</div>
    </div>
  </div>

  <!-- Textual stats -->
  <div class="card">
    <h3 style="margin-top:0">Text Stats</h3>
    <ul class="muted" style="list-style:none;padding-left:0;margin:.4rem 0 0">
      <li><strong>Total Revenue:</strong> <span id="stat_total_revenue">-</span></li>
      <li><strong>Total Orders:</strong> <span id="stat_total_orders">-</span></li>
      <li><strong>Avg Order Value:</strong> <span id="stat_aov">-</span></li>
      <li><strong>Best Month (Revenue):</strong> <span id="stat_best_month_rev">-</span></li>
      <li><strong>Best Month (Orders):</strong> <span id="stat_best_month_orders">-</span></li>
      <li><strong>Top Category (All‑time):</strong> <span id="stat_top_category">-</span></li>
      <li><strong>Busiest Time Slot:</strong> <span id="stat_busiest_slot">-</span></li>
    </ul>
  </div>

  <!-- Category mix -->
  <div class="card">
    <h3 style="margin-top:0">Category Mix by Month</h3>
    <p class="lt-note">Stacked by category to reveal mix shifts.</p>
    <div id="cat_wrap">
      <div id="cat_loading" class="muted-small">Loading category data…</div>
      <canvas id="chart_category" class="lt-canvas sm" style="display:none"></canvas>
      <div id="cat_error" class="muted-small error" style="display:none">Failed to load category data.</div>
    </div>
  </div>

  <!-- Heatmap -->
  <div class="card">
    <h3 style="margin-top:0">Peak Hours Heatmap</h3>
    <p class="lt-note">Orders by weekday and hour. Darker cells are busier.</p>
    <div class="legend" style="margin:.3rem 0 .6rem">
      <span class="sw" style="background:rgba(255,77,79,.10)"></span><span class="muted-small">Light</span>
      <span class="sw" style="background:rgba(255,77,79,.55)"></span><span class="muted-small">Busy</span>
    </div>
    <div id="hm_wrap" class="lt-hm">
      <div id="hm_loading" class="muted-small" style="padding:6px">Loading heatmap…</div>
      <div id="heatmap" style="display:none"></div>
      <div id="hm_error" class="muted-small error" style="display:none;padding:6px">Failed to load heatmap.</div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const fmtMoney = v => '$' + (Number(v||0)).toFixed(2);
  async function getJSON(url){
    const res = await fetch(url, {headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error('HTTP '+res.status);
    return await res.json();
  }
  function palette(n){
    const base=['#ff4d4f','#ffc53d','#40c463','#7180b9','#ff8f1f','#9b59b6','#2ecc71','#e74c3c','#3498db','#27ae60','#e67e22'];
    const out=[]; for(let i=0;i<n;i++) out.push(base[i%base.length]); return out;
  }

  let monthlyChart=null, categoryChart=null;

  function prettyMonth(iso){
    try{ const d = new Date(iso); return d.getFullYear()+ '-' + String(d.getMonth()+1).padStart(2,'0'); }
    catch(e){ return iso; }
  }

  function renderTextStats(monthly, category, heatmap){
    try{
      // Monthly totals
      const points = (monthly && monthly.points) ? monthly.points : [];
      const totalRevenue = points.reduce((s,p)=> s + Number(p.revenue||0), 0);
      const totalOrders = points.reduce((s,p)=> s + Number(p.orders||0), 0);
      const aov = totalOrders ? (totalRevenue / totalOrders) : 0;
      // Best months
      let bestRev = null, bestOrd = null;
      for(const p of points){
        if(!bestRev || Number(p.revenue||0) > Number(bestRev.revenue||0)) bestRev = p;
        if(!bestOrd || Number(p.orders||0) > Number(bestOrd.orders||0)) bestOrd = p;
      }
      // Top category (all-time revenue)
      const rows = (category && category.rows) ? category.rows : [];
      const catAgg = new Map();
      for(const r of rows){ catAgg.set(r.category, (catAgg.get(r.category)||0) + Number(r.revenue||0)); }
      let topCat = null, topCatVal = 0;
      for(const [k,v] of catAgg.entries()){ if(v>topCatVal){ topCat=k; topCatVal=v; } }
      // Busiest time slot from heatmap
      const hmRows = (heatmap && heatmap.rows) ? heatmap.rows : [];
      const labels = (heatmap && heatmap.weekday_labels) ? heatmap.weekday_labels : ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      let busy = null;
      for(const r of hmRows){ if(!busy || Number(r.orders||0) > Number(busy.orders||0)) busy = r; }
      const busyText = busy ? `${labels[(Number(busy.weekday||1)-1)%7]} @ ${String(busy.hour).padStart(2,'0')}:00 (${busy.orders} orders)` : '-';

      // Update DOM
      const byId = id => document.getElementById(id);
      if(byId('stat_total_revenue')) byId('stat_total_revenue').textContent = fmtMoney(totalRevenue);
      if(byId('stat_total_orders')) byId('stat_total_orders').textContent = (totalOrders||0).toLocaleString();
      if(byId('stat_aov')) byId('stat_aov').textContent = fmtMoney(aov);
      if(byId('stat_best_month_rev')) byId('stat_best_month_rev').textContent = bestRev ? `${prettyMonth(bestRev.month)} — ${fmtMoney(bestRev.revenue)}` : '-';
      if(byId('stat_best_month_orders')) byId('stat_best_month_orders').textContent = bestOrd ? `${prettyMonth(bestOrd.month)} — ${Number(bestOrd.orders||0)} orders` : '-';
      if(byId('stat_top_category')) byId('stat_top_category').textContent = topCat ? `${topCat} — ${fmtMoney(topCatVal)}` : '-';
      if(byId('stat_busiest_slot')) byId('stat_busiest_slot').textContent = busyText;
    }catch(e){ console.error('renderTextStats failed', e); }
  }

  async function loadMonthly(){
    const loading = document.getElementById('monthly_loading');
    const canvas = document.getElementById('chart_monthly');
    const err = document.getElementById('monthly_error');
    loading.style.display='block'; canvas.style.display='none'; err.style.display='none';
    try{
      const data = await getJSON('{% url "managers:api_monthly" %}');
      const labels = data.points.map(p=>p.month);
      const revenue = data.points.map(p=>p.revenue);
      const orders = data.points.map(p=>p.orders);
      loading.style.display='none'; canvas.style.display='block';
      if(monthlyChart){ monthlyChart.destroy(); }
      monthlyChart = new Chart(canvas.getContext('2d'), {
        type:'line',
        data:{ labels,
          datasets:[
            {label:'Revenue', data:revenue, borderColor:'#ff4d4f', backgroundColor:'rgba(255,77,79,.18)', yAxisID:'y', tension:.25, fill:true, pointRadius:0},
            {label:'Orders', data:orders, borderColor:'#40c463', backgroundColor:'rgba(64,196,99,.18)', yAxisID:'y1', tension:.25, pointRadius:0}
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          interaction:{mode:'index', intersect:false},
          scales:{
            y:{type:'linear', position:'left', grid:{color:'rgba(255,255,255,.06)'}, ticks:{color:'#e8eaed'}},
            y1:{type:'linear', position:'right', grid:{drawOnChartArea:false}, ticks:{color:'#e8eaed'}},
            x:{grid:{color:'rgba(255,255,255,.06)'}, ticks:{color:'#e8eaed', maxRotation:0, autoSkip:true, maxTicksLimit:12}}
          },
          plugins:{legend:{labels:{color:'#e8eaed'}}}
        }
      });
      return data;
    }catch(e){
      console.error(e); loading.style.display='none'; err.style.display='block';
      return null;
    }
  }

  async function loadCategory(){
    const loading = document.getElementById('cat_loading');
    const canvas = document.getElementById('chart_category');
    const err = document.getElementById('cat_error');
    loading.style.display='block'; canvas.style.display='none'; err.style.display='none';
    try{
      const data = await getJSON('{% url "managers:api_category_monthly" %}');
      const months = Array.from(new Set(data.rows.map(r=>r.month))).sort();
      const categories = Array.from(new Set(data.rows.map(r=>r.category)));
      const colors = palette(categories.length);
      const map = {};
      for(const r of data.rows){ map[r.category+'|'+r.month] = r.revenue; }
      const datasets = categories.map((cat,i)=>({
        label:cat,
        data: months.map(m=>map[cat+'|'+m]||0),
        backgroundColor: colors[i]+'55', borderColor: colors[i], borderWidth:1, stack:'stack1'
      }));
      loading.style.display='none'; canvas.style.display='block';
      if(categoryChart){ categoryChart.destroy(); }
      categoryChart = new Chart(canvas.getContext('2d'), {
        type:'bar', data:{labels:months, datasets},
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{
            x:{stacked:true, grid:{color:'rgba(255,255,255,.06)'}, ticks:{color:'#e8eaed', maxRotation:0, autoSkip:true, maxTicksLimit:12}},
            y:{stacked:true, grid:{color:'rgba(255,255,255,.06)'}, ticks:{color:'#e8eaed'}}
          },
          plugins:{legend:{labels:{color:'#e8eaed'}}}
        }
      });
      return data;
    }catch(e){ console.error(e); loading.style.display='none'; err.style.display='block'; return null; }
  }

  function renderHeatmap(containerId, rows, weekdayLabels){
    const cont = document.getElementById(containerId);
    const max = rows.reduce((m,r)=> Math.max(m, r.orders), 0) || 1;
    const w = 26, h = 22;
    const map = new Map(); for(const r of rows){ map.set(`${r.weekday}-${r.hour}`, r.orders); }
    const labels = weekdayLabels;
    let html = '<table class="sticky-top sticky-left" style="border-collapse:collapse">';
    html += '<tr><th></th>';
    for(let hr=0; hr<24; hr++){ html += `<th style="padding:6px 4px;color:#a7adba;backdrop-filter:blur(2px)">${hr}</th>`; }
    html += '</tr>';
    for(let i=0;i<7;i++){
      const wd = i+1;
      html += `<tr><th style="text-align:right;padding:0 8px;color:#a7adba">${labels[i]}</th>`;
      for(let hr=0; hr<24; hr++){
        const v = map.get(`${wd}-${hr}`) || 0;
        const intensity = 0.08 + 0.6*((v/max)||0);
        const bg = `rgba(255,77,79,${intensity})`;
        html += `<td title="${labels[i]} ${hr}:00 — ${v} orders" style="width:${w}px;height:${h}px;border:1px solid rgba(255,255,255,.06);background:${bg}"></td>`;
      }
      html += '</tr>';
    }
    html += '</table>';
    cont.innerHTML = html;
  }

  async function loadHeatmap(){
    const loading = document.getElementById('hm_loading');
    const panel = document.getElementById('heatmap');
    const err = document.getElementById('hm_error');
    loading.style.display='block'; panel.style.display='none'; err.style.display='none';
    try{
      const data = await getJSON('{% url "managers:api_hourly_heatmap" %}');
      loading.style.display='none'; panel.style.display='block';
      renderHeatmap('heatmap', data.rows, data.weekday_labels);
      return data;
    }catch(e){ console.error(e); loading.style.display='none'; err.style.display='block'; return null; }
  }

  async function init(){
    const [monthly, category, heatmap] = await Promise.all([loadMonthly(), loadCategory(), loadHeatmap()]);
    renderTextStats(monthly||{}, category||{}, heatmap||{});
  }
  document.getElementById('btn_refresh').addEventListener('click', init);
  init();
</script>
{% endblock %}
